{% extends "base.html" %}

{% block content %}
<div class="analysis-container">
    <div class="analysis-form-panel glass-card"
        style="border-radius: 0; border: none; border-right: var(--glass-border);">
        <h2 style="margin-bottom: 2rem;">Property Analysis</h2>
        <form id="analysis-form">
            <div class="form-group">
                <label class="form-label">Property ID / Name</label>
                <input type="text" class="form-input" id="property-id" placeholder="e.g. PROP-2024-001">
            </div>
            <div class="form-group">
                <label class="form-label">Address or Coordinates</label>
                <div class="input-group" style="display: flex; gap: 0.5rem;">
                    <input type="text" class="form-input" id="location" placeholder="e.g. 123 Ocean Drive, Miami, FL"
                        required style="flex: 1;">
                    <button type="button" class="btn btn-outline" id="locate-btn" title="Use My Location"
                        style="padding: 0.75rem;">
                        <i class="fa-solid fa-crosshairs"></i>
                    </button>
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">Asset Value ($)</label>
                <input type="number" class="form-input" id="value" placeholder="1000000">
            </div>
            <div class="form-group">
                <label class="form-label">Loan Term (Years)</label>
                <select class="form-input" id="term">
                    <option value="15">15 Years</option>
                    <option value="30" selected>30 Years</option>
                </select>
            </div>
            <button type="submit" class="btn btn-cta" style="width: 100%; margin-top: 1rem;">
                <i class="fa-solid fa-bolt"></i> Generate Score
            </button>
        </form>
        <div id="loading" style="display: none; text-align: center; margin-top: 2rem; color: var(--accent-green);">
            <i class="fa-solid fa-circle-notch fa-spin fa-2x"></i>
            <p style="margin-top: 0.5rem;">Analyzing climate models...</p>
        </div>
    </div>
    <div class="map-panel">
        <div id="map"></div>
    </div>

    <!-- New: Insights Panel -->
    <div class="insights-panel animate-fade-in">
        <div class="glass-card insight-card">
            <h3>Regional Risk Profile</h3>
            <div class="chart-container">
                <canvas id="riskRadarChart"></canvas>
            </div>
            <p class="insight-meta">Aggregated risk factors from local climate models.</p>
        </div>

        <div class="glass-card insight-card">
            <h3>Historical Temp. Trend</h3>
            <div class="chart-container">
                <canvas id="tempTrendChart"></canvas>
            </div>
        </div>

        <div class="glass-card insight-card">
            <h3>Environmental Composition</h3>
            <div class="chart-container">
                <canvas id="compositionChart"></canvas>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/map.js') }}"></script>
<script src="{{ url_for('static', filename='js/analysis_charts.js') }}"></script>
<script>
    // Initialize map and charts immediately
    initMap('map', 'location');
    initAnalysisCharts();

    // Hook into map location changes to update charts
    // We override searchLocation partially or just check for input changes
    const originalSearch = window.searchLocation;
    window.searchLocation = async function (query) {
        await originalSearch(query);
        updateAnalysisCharts(query);
    };

    // Also update on map click (reverse geocode)
    const locationInput = document.getElementById('location');
    const observer = new MutationObserver(() => {
        updateAnalysisCharts(locationInput.value);
    });
    // This is a hack because setting .value doesn't trigger 'change'
    setInterval(() => {
        if (locationInput.dataset.lastVal !== locationInput.value) {
            updateAnalysisCharts(locationInput.value);
            locationInput.dataset.lastVal = locationInput.value;
        }
    }, 1000);
</script>
{% endblock %}